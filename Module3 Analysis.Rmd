---
title: "Module3"
author: "HanGyuKang"
date: "11/15/2020"
output: html_document
---

```{r}
library(RJSONIO)
```

```{r}
dat <- read.csv("Data/df.csv",header=TRUE)
star.dat <- dat[,c(2,11:dim(dat)[2])]
words <- apply(star.dat[,2:dim(star.dat)[2]],2,sum)
sort(words, decreasing= TRUE)
```

```{r}
tapply(dat$stars_x,dat$name,mean)
```

```{r}
attri.json <- dat$attributes
attri.json
```

```{r}
word.frequency <- function(argument1){
ind <- argument1
total.star1 <-length(which(star.dat$stars_x == 1))
total.star2 <-length(which(star.dat$stars_x == 2))
total.star3 <-length(which(star.dat$stars_x == 3))
total.star4 <-length(which(star.dat$stars_x == 4))
total.star5 <-length(which(star.dat$stars_x == 5))
total.v <- c(total.star1,total.star2,total.star3,total.star4,total.star5)

freq.dat <- cbind(star.dat$stars_x,star.dat[,ind])
star1 <-length(which(freq.dat[,1] == 1 & freq.dat[,2] >= 1))
star2 <-length(which(freq.dat[,1] == 2 & freq.dat[,2] >= 1))
star3 <-length(which(freq.dat[,1] == 3 & freq.dat[,2] >= 1))
star4 <-length(which(freq.dat[,1] == 4 & freq.dat[,2] >= 1))
star5 <-length(which(freq.dat[,1] == 5 & freq.dat[,2] >= 1))
v <- c(star1, star2, star3, star4, star5)

Frequency <- v/total.v

barplot(Frequency, xlab = "Rates", ylab = "Word Frequency", main=ind)
}
```

```{r}
par(mfrow=c(3,3))
word.frequency("great")
word.frequency("nice")
word.frequency("good")
word.frequency("bad")
word.frequency("like")
word.frequency("well")
word.frequency("best")
word.frequency("better")
word.frequency("love")
word.frequency("recommend")
word.frequency("awesome")
word.frequency("worst")
word.frequency("perfect")
word.frequency("wonderful")
word.frequency("enjoyed")
word.frequency("excellent")
word.frequency("horrible")
word.frequency("average")
```


```{r}
par(mfrow=c(3,3))
word.frequency("staff")
word.frequency("service")
word.frequency("wait")
word.frequency("employee")
word.frequency("rude")
word.frequency("friendly")
word.frequency("manager")
word.frequency("care")
word.frequency("management")
word.frequency("reservation")
word.frequency("helpful")
word.frequency("decent")
word.frequency("breakfast")
word.frequency("coffee")
word.frequency("price")
```
```{r}
par(mfrow=c(3,3))
word.frequency("room")
word.frequency("bed")
word.frequency("desk")
word.frequency("bathroom")
word.frequency("pool")
word.frequency("tub")
word.frequency("shower")
word.frequency("lobby")
word.frequency("wifi")
word.frequency("tv")
word.frequency("elevator")
word.frequency("fridge")
word.frequency("window")
word.frequency("wall")
word.frequency("pillow")
word.frequency("parking")
word.frequency("suite")
word.frequency("facility")
word.frequency("towel")
word.frequency("gym")
word.frequency("ac")
```
```{r}
par(mfrow=c(3,3))
word.frequency("shuttle")
word.frequency("downtown")
word.frequency("airport")
word.frequency("bus")
word.frequency("drink")
word.frequency("distance")
word.frequency("bar")
word.frequency("location")
word.frequency("restaurant")
word.frequency("park")
word.frequency("security")
word.frequency("near")
```
```{r}
par(mfrow=c(3,3))
word.frequency("family")
word.frequency("kid")
word.frequency("clean")
word.frequency("comfortable")
word.frequency("small")
word.frequency("pretty")
word.frequency("quiet")
word.frequency("beautiful")
word.frequency("spacious")
word.frequency("modern")
word.frequency("noise")
word.frequency("smell")
word.frequency("amenity")
```

```{r}
freq <- function(argument1){
ind <- argument1
total.star1 <-length(which(star.dat$stars_x == 1))
total.star2 <-length(which(star.dat$stars_x == 2))
total.star3 <-length(which(star.dat$stars_x == 3))
total.star4 <-length(which(star.dat$stars_x == 4))
total.star5 <-length(which(star.dat$stars_x == 5))
total.v <- c(total.star1,total.star2,total.star3,total.star4,total.star5)

freq.dat <- cbind(star.dat$stars_x,star.dat[,ind])
star1 <-length(which(freq.dat[,1] == 1 & freq.dat[,2] >= 1))
star2 <-length(which(freq.dat[,1] == 2 & freq.dat[,2] >= 1))
star3 <-length(which(freq.dat[,1] == 3 & freq.dat[,2] >= 1))
star4 <-length(which(freq.dat[,1] == 4 & freq.dat[,2] >= 1))
star5 <-length(which(freq.dat[,1] == 5 & freq.dat[,2] >= 1))
v <- c(star1, star2, star3, star4, star5)

freq <- v/total.v
freq
}


freq.mat <- matrix(rep(NA,5),nrow=5)
for (i in 1:dim(star.dat)[2]-1){
  freq.vec <- freq(colnames(star.dat)[i+1])
  freq.mat <- cbind(freq.mat,freq.vec)
}
star.level <- levels(as.factor(star.dat$stars_x))
freq.data <- freq.mat[,-(1:2)]
colnames(freq.data) <- colnames(star.dat)[2:dim(star.dat)[2]]
freq.data <- as.data.frame(cbind(star.level,freq.data))


dup.dat <- star.dat
for (i in 1:dim(star.dat)[2]-1){
  dup.dat[which(star.dat[,i+1] >=1),i+1]=1
}
stars <- star.dat[,1]
dup.dat <- cbind(stars,dup.dat[,-1])
```

```{r}
library(gbm)
library(randomForest)

pow <- seq(-10, 0, by = 0.1)
lambdas <- 10^pow
test.boosting.error <- rep(NA, length(lambdas))
for (i in 1:length(lambdas)) {
  set.seed(628)
  boost.dat <- gbm(stars~great+nice+good+bad+like+well+best+better+love+recommend+awesome+worst+perfect+wonderful+enjoyed+excellent+horrible+average+staff+service+wait+employee+rude+friendly+manager+care+management+reservation+helpful+decent+breakfast+coffee+price+room+bed+desk+bathroom+pool+tub+shower+lobby+wifi+tv+elevator+fridge+window+wall+pillow+parking+suite+facility+towel+gym+ac+shuttle+downtown+airport+bus+drink+distance+bar+location+restaurant+park+security+near+family+kid+clean+comfortable+small+pretty+quiet+beautiful+spacious+modern+noise+smell+amenity, data = dup.dat, n.trees=1000, interaction.depth = 1, distribution = "multinomial", shrinkage = lambdas[i], cv.folds = 10)
  test.pred <- apply(predict(boost.dat, dup.dat, n.trees=1000), 1, which.max)
  test.boosting.error[i] <- 1-sum(diag(table(test.pred, dup.dat$stars)))/sum(table(test.pred, dup.dat$stars))
}
plot(lambdas, test.boosting.error, type="b", xlab = "lambda", ylab="MSE")

min.lambda <- lambdas[which.min(test.boosting.error)]
min.lambda

test.boosting.error1 <- rep(NA, 1000)
for (i in 1:1000) {
  set.seed(628)
  boost.dat <- gbm(stars~great+nice+good+bad+like+well+best+better+love+recommend+awesome+worst+perfect+wonderful+enjoyed+excellent+horrible+average+staff+service+wait+employee+rude+friendly+manager+care+management+reservation+helpful+decent+breakfast+coffee+price+room+bed+desk+bathroom+pool+tub+shower+lobby+wifi+tv+elevator+fridge+window+wall+pillow+parking+suite+facility+towel+gym+ac+shuttle+downtown+airport+bus+drink+distance+bar+location+restaurant+park+security+near+family+kid+clean+comfortable+small+pretty+quiet+beautiful+spacious+modern+noise+smell+amenity, data = dup.dat, interaction.depth = 1, distribution = "multinomial", n.trees=i, shrinkage = min.lambda)
  test.pred <- apply(predict(boost.dat, dup.dat, n.trees=i), 1, which.max)
  test.boosting.error1[i] <- 1-sum(diag(table(test.pred, dup.dat$stars)))/sum(table(test.pred, dup.dat$stars))
}

test.boosting.error2 <- rep(NA, 1000)
for (i in 1:1000) {
  set.seed(628)
  boost.dat <- gbm(stars~great+nice+good+bad+like+well+best+better+love+recommend+awesome+worst+perfect+wonderful+enjoyed+excellent+horrible+average+staff+service+wait+employee+rude+friendly+manager+care+management+reservation+helpful+decent+breakfast+coffee+price+room+bed+desk+bathroom+pool+tub+shower+lobby+wifi+tv+elevator+fridge+window+wall+pillow+parking+suite+facility+towel+gym+ac+shuttle+downtown+airport+bus+drink+distance+bar+location+restaurant+park+security+near+family+kid+clean+comfortable+small+pretty+quiet+beautiful+spacious+modern+noise+smell+amenity, data = dup.dat, n.trees=i, interaction.depth = 2, distribution = "multinomial", shrinkage = min.lambda)
  test.pred <- apply(predict(boost.dat, dup.dat, n.trees=i), 1, which.max)
  test.boosting.error2[i] <- 1-sum(diag(table(test.pred, dup.dat$stars)))/sum(table(test.pred, dup.dat$stars))
}

#randomforest
test.rf.MSE <- rep(NA, length=1000)
for(i in 1:1000){
  set.seed(628)
  rf.dat = randomForest(BODYFAT~.-IDNO-BODYFAT-DENSITY, data=train.dat, mtry = floor(sqrt(14)), ntree=i)
  yhat.rf = predict(rf.dat, newdata = test.dat)
  test.rf.MSE[i] <- sum((test.dat$BODYFAT-yhat.rf)^2)/dim(test.dat)[1]
  }

#bagging
test.bag.MSE <- rep(NA, length=1000)
for(i in 1:1000){
  set.seed(628)
  bag.dat = randomForest(BODYFAT~.-IDNO-BODYFAT-DENSITY, data=train.dat, mtry = 14, ntree=i)
  yhat.bag = predict(bag.dat, newdata = test.dat)
  test.bag.MSE[i] <- sum((test.dat$BODYFAT-yhat.bag)^2)/dim(test.dat)[1]
  }

ntree <- 1:1000
plot(ntree, test.rf.MSE, type = 'l', ylab="MSE", col=2, ylim=c(10,60), lwd = 2)
par(new=T)
plot(ntree, test.bag.MSE, type = 'l', ylab="MSE", ylim=c(10,60), col=4)
par(new=T)
plot(ntree, test.boosting.MSE1, type = 'l', ylab="MSE", ylim=c(10,60), col=3)
par(new=T)
plot(ntree, test.boosting.MSE2, type = 'l', ylab="MSE", ylim=c(10,60), col=5)
legend("topright", c("RandomForest","Bagging","Boosting: depth=1", "Boosting: depth=2"), lwd=c(1,1), col=c(2,4,3,5))


#randomforest
set.seed(628)
rf.dat = randomForest(BODYFAT~.-IDNO-BODYFAT-DENSITY,data=train.dat, mtry = 14, ntree=1000)
importance(rf.dat)
varImpPlot(rf.dat)

#boosting
set.seed(628)
boost.dat <- gbm(BODYFAT~.-IDNO-BODYFAT-DENSITY, data = train.dat, n.trees = 1000, interaction.depth = 2, distribution = "gaussian", shrinkage = min.lambda)
summary(boost.dat)


library(nnet)
m1 <- multinom(stars~room+second+floor+nice+decor+furniture,data = dup.dat)
predict(m1,newdata = dup.dat)
summary(m1)
```


```{r}
dat2 <- read.csv("Data/df_tip.csv",header=TRUE)
tip.dat <- dat2[,c(2,11:dim(dat2)[2])]
tip.words <- apply(tip.dat[,2:dim(tip.dat)[2]],2,sum)
sort(tip.words, decreasing= TRUE)

word.tip.frequency <- function(argument1){
ind <- argument1
total.star1 <-length(which(tip.dat$stars == 1))
total.star1.5 <-length(which(tip.dat$stars == 1.5))
total.star2 <-length(which(tip.dat$stars == 2))
total.star2.5 <-length(which(tip.dat$stars == 2.5))
total.star3 <-length(which(tip.dat$stars == 3))
total.star3.5 <-length(which(tip.dat$stars == 3.5))
total.star4 <-length(which(tip.dat$stars == 4))
total.star4.5 <-length(which(tip.dat$stars == 4.5))
total.star5 <-length(which(tip.dat$stars == 5))
total.v <- c(total.star1,total.star1.5, total.star2, total.star2.5, total.star3, total.star3.5, total.star4,total.star4.5, total.star5)

freq.dat <- cbind(tip.dat$stars,tip.dat[,ind])
star1 <-length(which(freq.dat[,1] == 1 & freq.dat[,2] >= 1))
star1.5 <-length(which(freq.dat[,1] == 1.5 & freq.dat[,2] >= 1))
star2 <-length(which(freq.dat[,1] == 2 & freq.dat[,2] >= 1))
star2.5 <-length(which(freq.dat[,1] == 2.5 & freq.dat[,2] >= 1))
star3 <-length(which(freq.dat[,1] == 3 & freq.dat[,2] >= 1))
star3.5 <-length(which(freq.dat[,1] == 3.5 & freq.dat[,2] >= 1))
star4 <-length(which(freq.dat[,1] == 4 & freq.dat[,2] >= 1))
star4.5 <-length(which(freq.dat[,1] == 4.5 & freq.dat[,2] >= 1))
star5 <-length(which(freq.dat[,1] == 5 & freq.dat[,2] >= 1))
v <- c(star1, star1.5, star2, star2.5, star3, star3.5, star4, star4.5, star5)

Frequency <- v/total.v

barplot(Frequency, xlab = "Rates", ylab = "Word Frequency", main=ind)
}

word.tip.frequency("room")
```